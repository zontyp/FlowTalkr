{
  "start": "setCommandType",
  "nodes": [
    {
      "name": "setCommandType",
      "type": "SET",
      "config": {
        "commandType": {
          "from": "$.command",
          "op": "SPLIT_BEFORE",
          "arg": ":"
        }
      },
      "next": {
        "default": "commandTypeSwitch"
      }
    },

    {
      "name": "commandSwitch",
      "type": "SWITCH",
      "config": {
        "field": "$.command"
      },
      "next": {
        "addhabit": "writeIsAddHabit",
        "default": "readIsAddingHabit",
        "done": "readUserHabits"
      }
    },

    {
      "name": "readUserHabits",
      "type": "PG_READ",
      "config": {
        "query": "SELECT id, habit_name FROM user_habits WHERE user_id = :userId ORDER BY id ASC",
        "resultMode": "LIST",
        "resultKey": "habits"
      },
      "next": {
        "default": "sendHabitsDone"
      }
    },


    {
      "name": "readIsAddingHabit",
      "type": "PG_READ",
      "config": {
        "query": "SELECT COALESCE((SELECT is_adding_habit FROM user_state WHERE user_id = :userId), false) AS is_adding_habit",
        "resultMode": "SINGLE"
      },
      "next": {
        "default": "ifIsReadingHabit"
      }
    },

    {
      "name": "ifIsReadingHabit",
      "type": "IF",
      "config": {
        "left": "$.is_adding_habit",
        "operator": "EQUALS",
        "right": "true"
      },
      "next": {
        "true": "writeInsertHabit",
        "false": "helpFlow"
      }
    },


    {
      "name": "writeIsAddHabit",
      "type": "PG_WRITE",
      "config": {
        "query": "INSERT INTO user_state (user_id, is_adding_habit) VALUES (:userId, true) ON CONFLICT (user_id) DO UPDATE SET is_adding_habit = true"
      },
      "next": {
        "default": "sendHabitNameAskMsg"
      }
    },
    {
      "name": "writeInsertHabit",
      "type": "PG_WRITE",
      "config": {
        "query": "INSERT INTO user_habits (user_id, habit_name, created_at) VALUES (:userId, :command, NOW())"
      },
      "next": {
        "default": "writeResetAddHabitState"
      }
    },

    {
      "name": "writeResetAddHabitState",
      "type": "PG_WRITE",
      "config": {
        "query": "INSERT INTO user_state (user_id, is_adding_habit) VALUES (:userId, false) ON CONFLICT (user_id) DO UPDATE SET is_adding_habit = false"
      },
      "next": {
        "default": "sendHabitAddedSuccessfully"
      }
    },
    {
      "name": "sendHabitNameAskMsg",
      "type": "TG_SEND",
      "config": {
        "text": "Please type habit name to add the habit. example - 'Daily Run', 'Sleep On Time' etc."
      }
    },
    {
      "name": "sendHabitAddedSuccessfully",
      "type": "TG_SEND",
      "config": {
        "text": "We added your habit successfully."
      }
    },
    {
      "name": "helpFlow",
      "type": "TG_SEND",
      "config": {
        "text": "Help Message"
      }
    },
    {
      "name": "sendHabitsDone",
      "type": "TG_SEND",
      "config": {
        "mode": "MULTI_ITEM_SINGLE_MESSAGE",
        "listPath": "$.habits",
        "headerText": "Your habits for today üëá",
        "rowTemplate": [
          {
            "text": "üëç {habit_name}",
            "callback_data": "done:{id}"
          },
          {
            "text": "üëé",
            "callback_data": "skip:{id}"
          }
        ]
      }
    }



  ]
}