{
  "start": "commandSwitch",
  "nodes": [

    {
      "name": "commandSwitch",
      "type": "SWITCH",
      "config": {
        "cases": [
          {
            "left": "$.command",
            "op": "STARTS_WITH",
            "right": "done:",
            "next": "setHabitIdForDone"
          },
          {
            "left": "$.command",
            "op": "STARTS_WITH",
            "right": "skip:",
            "next": "setHabitIdForSkip"
          },
          {
            "left": "$.command",
            "op": "EQUALS",
            "right": "addhabit",
            "next": "writeIsAddHabit"
          },
          {
            "left": "$.command",
            "op": "EQUALS",
            "right": "listhabits",
            "next": "readUserHabits"
          },
          {
            "left": "$.command",
            "op": "STARTS_WITH",
            "right": "stats ",
            "next": "setStatsHabitName"
          }

        ],
        "default": "readIsAddingHabit"
      }
    },
    {
      "name": "setStatsHabitName",
      "type": "SET",
      "config": {
        "statsHabitName": {
          "from": "$.command",
          "op": "SUBSTRING_AFTER",
          "arg": "stats "
        },
        "next": "readHabitStats"
      }
    },


    {
      "name": "setHabitIdForDone",
      "type": "SET",
      "config": {
        "habitId": {
          "from": "$.command",
          "op": "SPLIT_AFTER",
          "arg": ":"
        },
        "next": "writeHabitDone"
      }
    },

    {
      "name": "setHabitIdForSkip",
      "type": "SET",
      "config": {
        "habitId": {
          "from": "$.command",
          "op": "SPLIT_AFTER",
          "arg": ":"
        },
        "next": "writeHabitSkipped"
      }
    },

    {
      "name": "writeHabitDone",
      "type": "PG_WRITE",
      "config": {
        "query": "INSERT INTO user_habits_done (user_id, habit_id, done_date, status, created_at) VALUES (:userId, CAST(:habitId AS BIGINT), CURRENT_DATE, 'done', NOW()) ON CONFLICT (user_id, habit_id, done_date) DO UPDATE SET status = 'done', created_at = NOW()"
      }
    },

    {
      "name": "writeHabitSkipped",
      "type": "PG_WRITE",
      "config": {
        "query": "INSERT INTO user_habits_done (user_id, habit_id, done_date, status, created_at) VALUES (:userId, CAST(:habitId AS BIGINT), CURRENT_DATE, 'skipped', NOW()) ON CONFLICT (user_id, habit_id, done_date) DO UPDATE SET status = 'skipped', created_at = NOW()"
      }
    },
    {
      "name": "readHabitStats",
      "type": "PG_READ",
      "config": {
        "query": "SELECT uhd.done_date::text AS date, uhd.status FROM user_habits_done uhd JOIN user_habits uh ON uhd.habit_id = uh.id WHERE uh.user_id = :userId AND LOWER(TRIM(uh.habit_name)) = LOWER(TRIM(:statsHabitName)) ORDER BY uhd.done_date",
        "resultMode": "LIST",
        "resultKey": "stats",
        "next": "formatHabitStats"
      }
    },



    {
      "name": "readUserHabits",
      "type": "PG_READ",
      "config": {
        "query": "SELECT id, habit_name FROM user_habits WHERE user_id = :userId ORDER BY id ASC",
        "resultMode": "LIST",
        "resultKey": "habits",
        "next": "sendHabitsListActions"
      }
    },

    {
      "name": "readIsAddingHabit",
      "type": "PG_READ",
      "config": {
        "query": "SELECT COALESCE((SELECT is_adding_habit FROM user_state WHERE user_id = :userId), false) AS is_adding_habit",
        "resultMode": "SINGLE",
        "next": "ifIsReadingHabit"
      }
    },

    {
      "name": "ifIsReadingHabit",
      "type": "IF",
      "config": {
        "left": "$.is_adding_habit",
        "operator": "EQUALS",
        "right": "true",
        "trueNext": "writeInsertHabit",
        "falseNext": "helpFlow"
      }
    },

    {
      "name": "writeIsAddHabit",
      "type": "PG_WRITE",
      "config": {
        "query": "INSERT INTO user_state (user_id, is_adding_habit) VALUES (:userId, true) ON CONFLICT (user_id) DO UPDATE SET is_adding_habit = true",
        "next": "sendHabitNameAskMsg"
      }
    },

    {
      "name": "writeInsertHabit",
      "type": "PG_WRITE",
      "config": {
        "query": "INSERT INTO user_habits (user_id, habit_name, created_at) VALUES (:userId, :command, NOW())",
        "next": "writeResetAddHabitState"
      }
    },

    {
      "name": "writeResetAddHabitState",
      "type": "PG_WRITE",
      "config": {
        "query": "INSERT INTO user_state (user_id, is_adding_habit) VALUES (:userId, false) ON CONFLICT (user_id) DO UPDATE SET is_adding_habit = false",
        "next": "sendHabitAddedSuccessfully"
      }
    },
    {
      "name": "normalizeStatsJson",
      "type": "SET",
      "config": {
        "stats": {
          "from": "$.stats.value",
          "op": "PARSE_JSON"
        },
        "next": "formatHabitStats"
      }
    },

    {
      "name": "formatHabitStats",
      "type": "WASM",
      "config": {
        "wasmPath": "wasm/habit_stats_wasm.wasm",
        "outputKey": "statsText",
        "next": "sendHabitStats"
      }
    },


    {
      "name": "sendHabitNameAskMsg",
      "type": "TG_SEND",
      "config": {
        "text": "Please type habit name to add the habit. example - 'Daily Run', 'Sleep On Time' etc."
      }
    },

    {
      "name": "sendHabitAddedSuccessfully",
      "type": "TG_SEND",
      "config": {
        "text": "We added your habit successfully."
      }
    },

    {
      "name": "helpFlow",
      "type": "TG_SEND",
      "config": {
        "text": "Help Message"
      }
    },
    {
      "name": "sendHabitStats",
      "type": "TG_SEND",
      "config": {
        "text": "$.statsText"
      }
    },

    {
      "name": "sendHabitsListActions",
      "type": "TG_SEND",
      "config": {
        "mode": "MULTI_ITEM_SINGLE_MESSAGE",
        "listPath": "$.habits",
        "headerText": "Please mark (done / skipped) your habits for today üëá",
        "rowTemplate": [
          {
            "text": "üëç {habit_name}",
            "callback_data": "done:{id}"
          },
          {
            "text": "üëé",
            "callback_data": "skip:{id}"
          }
        ]
      }
    }
  ]
}
